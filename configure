#!/usr/bin/env bash

set -e

SCRIPT="$0"
SCRIPT_ARGS="$0 $@"
SCRIPT_DIR="$(cd -- "$(dirname -- "${BASH_SOURCE[0]}")" &> /dev/null && pwd)"

CONFIG_MK="$SCRIPT_DIR/config.mk"

PREFIX='/usr/local'
BUILD_PREFIX=./build

SHARD_ENABLE_GCBOEHM=0
SHARD_ENABLE_FFI=0
SHARD_ENABLE_LIBEDIT=0

ENABLE_ASAN=0
ENABLE_UBSAN=0

function error() {
    echo "$SCRIPT: error: $1"
    exit 1
}

function show_help() {
    echo "\`configure\` configures this package to your system."
    echo
    echo "Usage: $SCRIPT [OPTION]... [VAR=VALUE]..."
    echo 
    echo "To assign environment variables (e.g., CC, CFLAGS...), specify them as"
    echo "VAR=VALUE.  See below for descriptions of some of the useful variables."
    echo
    echo "Defaults for the options are specified in brackets."
    echo
    echo "Options:"
    echo "  -h, --help                    display this help text and exit"
    echo "      --prefix=PREFIX           install files in PREFIX [$PREFIX]"
    echo "      --build-prefix=BPREFIX    put build files in BPREFIX [$BUILD_PREFIX]"
    echo "      --enable-gcboehm=[yes|no] enable the boehm garbage collector [$SHARD_ENABLE_GCBOEHM]"
    echo "      --enable-ffi=[yes|no]     enable ffi capabilities [$SHARD_ENABLE_FFI]"
    echo "      --enable-libedit=[yes|no] enable libedit in the repl [$SHARD_ENABLE_LIBEDIT]"
    echo "      --enable-asan             enable the address sanitizer"
    echo "      --enable-ubsan            enable the UB sanitizer"
    echo
}

while [[ $# -gt 0 ]]; do
    case $1 in
        --prefix=*)
            PREFIX="${1#*=}"
            ;;
        --build-prefix=*)
            BUILD_PREFIX="${1#*=}"
            ;;
        --enable-gcboehm=y|--enable-gcboehm=yes)
            SHARD_ENABLE_GCBOEHM=1
            ;;
        --enable-gcboehm=n|--enable-gcboehm=no)
            SHARD_ENABLE_GCBOEHM=0
            ;;
        --enable-ffi=y|--enable-ffi=yes)
            SHARD_ENABLE_FFI=1
            ;;
        --enable-ffi=n|--enable-ffi=no)
            SHARD_ENABLE_FFI=0
            ;;
        --enable-libedit=y|--enable-libedit=yes)
            SHARD_ENABLE_LIBEDIT=1
            ;;
        --enable-libedit=n|--enable-libedit=no)
            SHARD_ENABLE_LIBEDIT=1
            ;;
        --enable-asan)
            ENABLE_ASAN=1
            ;;
        --enable-ubsan)
            ENABLE_UBSAN=1
            ;;
        -h|--help)
            show_help
            exit
            ;;
        *=*)
            export $1
            ;;
        *)
            error "unknown option -- '$1'"
            ;;
    esac
    shift
done

mkdir -p "$BUILD_PREFIX"

if [[ "$SHARD_ENABLE_GCBOEHM" -eq 1 ]]; then
    CFLAGS="$CFLAGS -DSHARD_ENABLE_GCBOEHM=1"
fi

if [[ "$SHARD_ENABLE_FFI" -eq 1 ]]; then
    CFLAGS="$CFLAGS -DSHARD_ENABLE_FFI=1"
fi

if [[ "$SHARD_ENABLE_LIBEDIT" -eq 1 ]]; then
    CFLAGS="$CFLAGS -DSHARD_ENABLE_LIBEDIT=1"
fi

SANITIZERS=""

if [[ "$ENABLE_ASAN" -eq 1 ]]; then
    if [[ -n "$SANITIZERS" ]]; then
        SANITIZIERS="$SANITIZERS,"
    fi
    SANITIZERS="$($SANITIZERS)address"
    LDFLAGS="$LDFLAGS -lasan"
fi

if [[ "$ENABLE_UBSAN" -eq 1 ]]; then
    if [[ -n "$SANITIZERS" ]]; then
        SANITIZIERS="$SANITIZERS,"
    fi
    SANITIZERS="$($SANITIZERS)undefined"
    LDFLAGS="$LDFLAGS -lubsan"
fi

cat > "$CONFIG_MK" <<EOF
# Generated by $SCRIPT_ARGS

CC=$CC
LD=$LD
AR=$AR
RANLIB=$RANLIB

PREFIX=$PREFIX
BUILD_PREFIX=$BUILD_PREFIX

CFLAGS=$CFLAGS
LDFLAGS=$LDFLAGS

EOF

"Configuration written to '$CONFIG_MK'."

